name: Claude Code

permissions:
  contents: write
  pull-requests: write
  issues: write

on:
  # 手動実行もできるようにしておくとデバッグが楽です
  workflow_dispatch:
  issue_comment:
    types: [created, edited]
  pull_request_review_comment:
    types: [created, edited]

jobs:
  claude:
    if: >
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'workflow_dispatch')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # === 健全性チェック（Secret と API 疎通） ===
      - name: Check ANTHROPIC_API_KEY presence
        env:
          KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          if [ -z "$KEY" ]; then
            echo "❌ Missing ANTHROPIC_API_KEY secret"
            exit 1
          fi
          echo "✅ ANTHROPIC_API_KEY is present (length: ${#KEY})"

      - name: Sanity-check Anthropic API key (expects 400 if valid)
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          code=$(curl -s -o /dev/null -w "%{http_code}" https://api.anthropic.com/v1/messages \
            -H "x-api-key: $ANTHROPIC_API_KEY" \
            -H "anthropic-version: 2023-06-01")
          echo "Anthropic API returned HTTP $code"
          # 401: キー無効、403: 権限/契約問題。400系ならキー自体は生きていることが多い。
          if [ "$code" = "401" ]; then
            echo "❌ 401 Unauthorized (APIキーが無効/誤りの可能性)"
            exit 1
          fi
          if [ "$code" = "403" ]; then
            echo "❌ 403 Forbidden (権限/請求設定/モデル許可の可能性)"
            exit 1
          fi

      # === Claude Code Action 本体 ===
      - name: Run Claude Code
        uses: anthropics/claude-code-action@main
        with:
          trigger_phrase: "@claude"
          github_token: ${{ secrets.GITHUB_TOKEN }}
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          # うまく通らない場合は、利用可能なモデルを明示指定
          # model: "claude-3-7-sonnet"
          timeout_minutes: "30"
